#!/usr/bin/ruby
# vi:ft=ruby

ROOT_PATH="<%= @deploy[:deploy_to] %>/current"
APP_NAME="<%= @application %>"
PID_PATH="<%= @deploy[:deploy_to] %>/shared/pids/faye.pid"

COMMAND=%w[bundle exec rackup -s thin -E production faye.ru]

def start_faye
  pid = fork do
    Dir.chdir(ROOT_PATH)
    exec *COMMAND
  end
  Process.detach(pid)
  File.open(PID_PATH, 'w') do |f|
    f.write(pid)
  end
end

def faye_pid
  if File.exist?(PID_PATH)
    File.read(PID_PATH).to_i
  end
end

def faye_status
  if pid = faye_pid
    puts "Faye <%= @application %> running with PID #{pid}"
    true
  else
    puts "Faye <%= @application %> not running"
    false
  end
end

def stop_faye
  if pid = faye_pid
    begin
      Process.kill "TERM", pid
    rescue Errno::ESRCH
    end
  end
end

case ARGV[0]
when "start"
  puts "Starting Faye #{APP_NAME}"
  start_faye
when "stop"
  puts "Stopping Faye #{APP_NAME}"
  stop_faye
when "restart"
  stop_faye
  start_faye
when "status"
  faye_status
else
  puts "Usage: {start|stop|restart}"
  exit 1
end

exit 0
